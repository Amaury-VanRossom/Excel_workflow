@inherits WizardStepBase
@inject ErrorService Err
@inject CsvParsingService Csv
@inject IJSRuntime JS
@using Models
@using excel_workflow.Models.Csv

@if(gentInfo is not null && aalstInfo is not null)
{
    
<div class="d-flex flex-row justify-content-evenly">
    <button @onclick="() => _showGentStudents = true">Gent</button>
    <button @onclick="DownloadCSV">Genereer CSV handtekenlijst</button>
    <button @onclick="DownloadPDF">Genereer PDF handtekenlijst</button>
    <button @onclick="() => _showGentStudents = false">Aalst</button>
</div>
<div class="d-flex flex-column justify-content-center">
    @(_showGentStudents ? @<StudentTableComponent students="gentInfo"/>
                        : @<StudentTableComponent students="aalstInfo"/>)
</div>
<div class="row justify-content-center">
    <div class="col-auto ">
        <button type="button" @onclick="ResetWizard" class="btn btn-primary">Begin opnieuw</button>
    </div>
</div>

<SignaturePrintTable entries="@((_showGentStudents ? gentInfo : aalstInfo).GetSignatureListRows(Wiz.WizardModel.ExamType).GroupBy(r => r.Lokaal))"/>
}

@code {
    public bool _showGentStudents = true;
    public IEnumerable<(Student, Olod, ExamRoom)> gentInfo;
    public IEnumerable<(Student, Olod, ExamRoom)> aalstInfo;
    //Tabel studenten afprinten als pdf

    protected async override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SetCityStudentInfo();
    }

    private void SetCityStudentInfo()
    {
        gentInfo = Wiz.WizardModel.Students.GetStudentInfoFromCity(Wiz.WizardModel.AssignedStudents, City.Gent, GetSortingFunction(City.Gent), Wiz.WizardModel.Olod!);
        aalstInfo = Wiz.WizardModel.Students.GetStudentInfoFromCity(Wiz.WizardModel.AssignedStudents, City.Aalst, GetSortingFunction(City.Aalst), Wiz.WizardModel.Olod!);
    }

    private async Task DownloadCSV()
    {
        var assignedStudentsAndRooms = _showGentStudents ? gentInfo : aalstInfo;
        var entries = assignedStudentsAndRooms.GetSignatureListRows(Wiz.WizardModel.ExamType!).OrderBy(r => r.Naam);
        var bytes = Csv.GenerateSignatureZip(entries);

        await JS.InvokeVoidAsync("downloadFile", "handtekeningenlijst.zip", "application/zip", bytes);
    }

    private async Task DownloadPDF()
    {
        await JS.InvokeVoidAsync("print");
    }

    private Func<IEnumerable<(Student, Olod, ExamRoom)>, IEnumerable<(Student, Olod, ExamRoom)>> GetSortingFunction(City city)
    {
        bool sorting =  Wiz.WizardModel.CityStudentOrderingByName[city.Equals(City.Gent) ? 0 : 1];
        if (sorting)
        {
            return list => list.OrderBy(l => l.Item3.Name).ThenBy(l => l.Item1.Name);
        }
        else
        {
            return list => list.OrderBy(l => l.Item3.Name).ThenBy(l => l.Item2.Subgroup).ThenBy(l => l.Item1.Name);
        }
    }
}
