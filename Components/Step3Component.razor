@inherits WizardStepBase
@inject CsvParsingService Csv

<FileUploadComponent T="Dictionary<int,Measure>"
                     PText="Select the .csv file with all the IOEM information."
                     H3Text="IOEM list"
                     Parser="ParseIOEM"
                     AssignResult="AssignMeasures"
                     GoToNextStep="GoToNextStep" />
@code {
    //IOEM.csv uploaden (misschien uploadopmaak in eigen component steken)

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    private async Task<Dictionary<int, Measure>> ParseIOEM(Stream stream)
    {
        return await Csv.ParseIOEM(stream).ToDictionaryAsync(t => t.Item1, t => t.Item2);
    }

    private void AssignMeasures(Dictionary<int, Measure> students)
    {
        foreach ((int number, Measure measure) in students)
        {
            if (Wiz.WizardModel.Students.TryGetValue(number, out var student))
            {
                student.Measures = measure; 
            }
        }
        var Measures = Enum.GetValues<Measure>()
            .AsEnumerable()
            .Where(e => !e.Equals(Measure.None) && Wiz.WizardModel.Students.Values.Any(s => s.Measures.HasFlag(e)));
        foreach (var measure in Measures)
        {
            Wiz.WizardModel.MeasuresTaken[measure] = MeasureTaken.None;
        }
    }
}
