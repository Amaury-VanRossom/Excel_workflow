@inherits WizardStepBase
@inject CsvParsingService Csv

<FileUploadComponent T="Dictionary<int,Measure>"
                     PText="Selecteer het .csv bestand met alle IOEM maatregels."
                     H3Text="IOEM lijst"
                     Parser="ParseIOEM"
                     AssignResult="AssignMeasures"
                     GoToNextStep="GoToNextStep" />
@code {
    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    private async Task<Dictionary<int, Measure>> ParseIOEM(Stream stream)
    {
        return await Csv.ParseIOEM(stream).ToDictionaryAsync(t => t.Item1, t => t.Item2);
    }

    private void AssignMeasures(Dictionary<int, Measure> students)
    {
        foreach ((int number, Measure measure) in students)
        {
            if (Wiz.WizardModel.Students.TryGetValue(number, out var student))
            {
                student.Measures = measure; 
            }
        }
        var Measures = Enum.GetValues<Measure>()
            .AsEnumerable()
            .Where(e => !e.Equals(Measure.None) && Wiz.WizardModel.Students.Values.Any(s => s.Measures.HasFlag(e)));
        foreach (var measure in Measures)
        {
            if (measure == Measure.DigitalCursus || measure == Measure.SeperateRoom)
            {
                if (Wiz.WizardModel.ExamType == ExamType.SCHRIFTELIJK)
                {
                    Wiz.WizardModel.MeasuresTaken[measure] = MeasureTaken.SB;
                }
                else
                {
                    Wiz.WizardModel.MeasuresTaken[measure] = MeasureTaken.SeperateRoom;
                }
            }
            else 
            {
                    Wiz.WizardModel.MeasuresTaken[measure] = MeasureTaken.None;
            }
        }
    }
}
